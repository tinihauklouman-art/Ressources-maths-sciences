<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kit Prof – Mesures collaboratives</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Firebase (optionnel pour collaboration temps réel) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    :root{
      --bg:#fff; --text:#0a0a0a; --muted:#374151; --border:#d1d5db; --focus:#1d4ed8;
      --btn:#1f2937; --btnText:#fff; --btnHover:#111827;
    }
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{padding:18px 24px;background:#f3f4f6;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:20px}
    .container{padding:18px;max-width:1100px;margin:auto}
    .panel{border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:16px}
    .panel h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);background:#f9fafb;font-size:16px}
    .panel .body{padding:14px}
    .btn{appearance:none;border:1px solid transparent;background:var(--btn);color:var(--btnText);border-radius:8px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn:hover{background:var(--btnHover)}
    input,textarea{width:100%;padding:10px 12px;border:1px solid #6b7280;border-radius:8px}
    input:focus,textarea:focus{outline:3px solid var(--focus);outline-offset:2px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--border);padding:6px}
    .stats{margin:6px 0 18px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    #chartContainer{margin-top:10px;border:1px solid var(--border);border-radius:12px;padding:10px;height:520px;min-height:420px}
    #chart{display:block;width:100%!important;height:100%!important}
    footer{margin:18px auto 24px;max-width:1100px;color:#6b7280;font-size:12px;text-align:right}
    .note{color:#6b7280;font-size:13px}
  </style>
</head>
<body>
  <header>
    <h1>Kit Prof – Mesures collaboratives</h1>
  </header>

  <div class="container">
    <div class="panel">
      <h2>Session partagée</h2>
      <div class="body">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label for="room" style="font-weight:700">Nom de la session :</label>
          <input id="room" type="text" placeholder="ex : TP-Groupe-1" style="max-width:240px">
          <button class="btn" id="joinRoom">Rejoindre</button>
          <span style="margin-left:auto" class="note">En ligne : <strong id="online">0</strong></span>
        </div>
        <p class="note" style="margin:8px 0 0">Sans configuration Firebase, la page fonctionne en <strong>mode local</strong> avec sauvegarde automatique dans le navigateur.</p>
      </div>
    </div>

    <div class="panel">
      <h2>Tableaux de mesures (Groupes A → E)</h2>
      <div class="body" id="tables"></div>
    </div>

    <div class="panel">
      <h2>Diagramme – Valeur mesurée (abscisse) vs Effectifs (ordonnée)</h2>
      <div class="body">
        <div id="chartContainer"><canvas id="chart"></canvas></div>
      </div>
    </div>
  </div>

  <footer>signature : <strong>tklouman</strong></footer>

<script>
// ==========================
//  Firebase (optionnel)
// ==========================
const firebaseConfig = {
  apiKey: "VOTRE_API_KEY",
  authDomain: "VOTRE_PROJET.firebaseapp.com",
  databaseURL: "https://VOTRE_PROJET-default-rtdb.firebaseio.com",
  projectId: "VOTRE_PROJET",
  storageBucket: "VOTRE_PROJET.appspot.com",
  messagingSenderId: "VOTRE_ID",
  appId: "VOTRE_APP_ID"
};
let fbApp=null, db=null, currentRoom='local', writeLock=false;
function looksConfigured(){return Object.values(firebaseConfig).every(v=>typeof v==='string' && v && !v.includes('VOTRE_'))}
function initFirebaseOnce(){ if(fbApp || !looksConfigured()) return; fbApp=firebase.initializeApp(firebaseConfig); db=firebase.database(); }

// ==========================
//  Génération des tableaux
// ==========================
const tables = document.getElementById('tables');
const groupOrder = ['A','B','C','D','E'];
function buildTables(){
  tables.innerHTML='';
  tables.style.display='grid';
  tables.style.gridTemplateColumns='repeat(3, 1fr)';
  tables.style.gap='12px';

  groupOrder.forEach((g, index)=>{
    const div=document.createElement('div');
    div.style.border='1px solid var(--border)';
    div.style.borderRadius='12px';
    div.style.padding='10px';

    div.innerHTML = `<h3>Groupe ${g}</h3>
      <table><thead><tr><th>Mesure n°</th><th>Valeur (unité libre)</th></tr></thead>
      <tbody>
        ${Array.from({length:6},(_,i)=>`<tr><td><input type='number' value='${i+1}' disabled></td><td><input type='number' step='any' data-group='${g}' data-idx='${i}' placeholder='Saisir une valeur'></td></tr>`).join('')}
      </tbody></table>
      <p class='stats'>Moyenne : <strong id='mean-${g}'>—</strong> · Étendue : <strong id='range-${g}'>—</strong></p>`;

    tables.appendChild(div);

    // Après le 3e tableau, on force une nouvelle rangée
    if(index === 2){
      const br=document.createElement('div');
      br.style.gridColumn='1 / -1';
      tables.appendChild(br);
    }
  });
}

buildTables();

// ==========================
//  Lecture / rendu DOM
// ==========================
function readValues(){
  const out={A:[],B:[],C:[],D:[],E:[]};
  document.querySelectorAll("tr td:nth-child(2) input[data-group]").forEach(inp=>{
    const v=parseFloat(inp.value); if(Number.isFinite(v)) out[inp.dataset.group].push(v);
  });
  return out;
}
function renderValues(values){
  // Nettoie puis applique au maximum 6 valeurs par groupe
  document.querySelectorAll("tr td:nth-child(2) input[data-group]").forEach(inp=>{inp.value=''});
  for(const g of groupOrder){
    (values[g]||[]).slice(0,6).forEach((v,i)=>{
      const el=document.querySelector(`input[data-group='${g}'][data-idx='${i}']`);
      if(el) el.value=v;
    });
  }
}

// ==========================
//  Stats + Graphique
// ==========================
const colors={A:'#b91c1c',B:'#1d4ed8',C:'#047857',D:'#b45309',E:'#6d28d9'};
const ctx=document.getElementById('chart');
const chart=new Chart(ctx,{type:'bar',data:{labels:[],datasets:[]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:{left:8,right:16,top:8,bottom:8}},scales:{x:{title:{display:true,text:'Valeur mesurée'},ticks:{maxRotation:0,autoSkip:true,maxTicksLimit:12}},y:{beginAtZero:true,title:{display:true,text:'Effectifs'},ticks:{precision:0}}},plugins:{legend:{position:'top'}}}});

function computeDataset(valuesByGroup){
  const labels=[...new Set(Object.values(valuesByGroup).flat())].sort((a,b)=>a-b);
  const datasets=Object.entries(valuesByGroup).map(([g,vals])=>({label:`Groupe ${g}`,backgroundColor:colors[g],data:labels.map(v=>vals.filter(x=>x===v).length)}));
  return {labels,datasets};
}
function updateStats(valuesByGroup){
  for(const [g,vals] of Object.entries(valuesByGroup)){
    const m=document.getElementById(`mean-${g}`), r=document.getElementById(`range-${g}`);
    if(vals.length){
      const mean=vals.reduce((a,b)=>a+b,0)/vals.length;
      const range=Math.max(...vals)-Math.min(...vals);
      m.textContent=mean.toLocaleString('fr-FR',{maximumFractionDigits:2});
      r.textContent=range.toLocaleString('fr-FR',{maximumFractionDigits:2});
    } else { m.textContent='—'; r.textContent='—'; }
  }
}
function refresh(){
  const vals=readValues();
  const {labels,datasets}=computeDataset(vals);
  chart.data.labels=labels; chart.data.datasets=datasets; chart.update();
  updateStats(vals);
}

tables.addEventListener('input',()=>{saveLocal(); pushFirebaseDebounced(); refresh();});

// ==========================
//  Sauvegarde locale (par session)
// ==========================
function localKey(){return `kitprof::${currentRoom||'local'}`}
function saveLocal(){try{localStorage.setItem(localKey(),JSON.stringify(readValues()))}catch(e){}
}
function loadLocal(){try{const raw=localStorage.getItem(localKey());return raw?JSON.parse(raw):null}catch(e){return null}}

// ==========================
//  Firebase temps réel (optionnel)
// ==========================
function valuesRef(){return db.ref(`rooms/${currentRoom}/kitprof`)}
function presenceRef(){return db.ref(`rooms/${currentRoom}/presence`)}
let presenceUnsub=null, valuesUnsub=null, pushTimer=null;
function bindPresence(){
  const onlineEl=document.getElementById('online');
  const me=presenceRef().push(); me.onDisconnect().remove(); me.set(true);
  presenceRef().on('value',snap=>{const v=snap.val()||{}; onlineEl.textContent=Object.keys(v).length;});
}
function unbind(){ if(valuesUnsub && db){valuesRef().off('value',valuesUnsub);} if(presenceUnsub && db){presenceRef().off('value',presenceUnsub);} }
function bindRoom(room){
  currentRoom=room||'local';
  // charge local pour affichage immédiat
  const local=loadLocal(); if(local){renderValues(local); refresh();}
  if(looksConfigured()){initFirebaseOnce();}
  if(!db) return; // uniquement local
  valuesRef().on('value', snap=>{ const remote=snap && snap.val(); if(!remote) return; writeLock=true; renderValues(remote); refresh(); writeLock=false; });
  bindPresence();
}
function pushFirebase(){ if(!db||writeLock) return; valuesRef().set(readValues()); }
function pushFirebaseDebounced(){ clearTimeout(pushTimer); pushTimer=setTimeout(pushFirebase,150); }

// ==========================
//  Session UI
// ==========================
const joinBtn=document.getElementById('joinRoom');
joinBtn.addEventListener('click',()=>{ const room=(document.getElementById('room').value||'').trim()||'public'; bindRoom(room); if(db&&looksConfigured()) pushFirebase(); });

// Init
buildTables(); bindRoom('local'); refresh();
</script>
</body>
</html>
